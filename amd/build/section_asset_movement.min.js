define(["jquery","core/log","core/templates","core/notification"],function(a,b,c,d){return{init:function(){var e,f=[],g=!1,h=a("#snap-move-message"),i=function(){a("body").removeClass("snap-move-inprogress"),a("body").removeClass("snap-move-section"),a("body").removeClass("snap-move-asset"),a(".section-moving").removeClass("section-moving"),a(".asset-moving").removeClass("asset-moving"),a(".js-snap-asset-move").removeAttr("checked"),f=[]},j=function(){a(".snap-move-notice").addClass("movefail"),a(".snap-move-notice .three-quarters").remove();var b=a(e).find(".instancename").html();a("#snap-move-message h5").html(M.util.get_string("movefailed","theme_snap",b)),window.setTimeout(function(){i(!1)},2e3)},k=function(){if(1===f.length){var b=a(f[0]).find(".snap-asset-link .instancename").html();b=b||M.str.label.pluginname;var c=M.util.get_string("moving","theme_snap",b);h.find(".snap-move-message-title").html(c)}else h.find(".snap-move-message-title").html(M.util.get_string("movingcount","theme_snap",f.length));h.focus()},l=function(a){var b=f.indexOf(a);b>-1&&f.splice(b,1),k()},m=function(b,c){if(0===a(b).find(".loadingstat").length){var d=c?" spinner-dark":"";a(b).append('<div class="loadingstat spinner-three-quarters'+d+'">'+M.util.get_string("loading","theme_snap")+"</div>")}},n=function(c,d,e,f){if(g)return void b.debug("Skipping ajax request, one already in progress");m(a("#snap-move-message .snap-move-message-title")),c.sesskey=M.cfg.sesskey,c.courseId=M.theme_snap.courseid,c.field="move",b.debug("Making course/rest.php request",c);var h=a.ajax({type:"POST",async:!0,data:c,url:M.cfg.wwwroot+M.theme_snap.courseconfig.ajaxurl});h.done(function(a){a.error?(b.debug("Ajax request fail"),j()):(b.debug("Ajax request successful"),e&&e(),f&&i())}),h.fail(function(){j()}),f&&h.complete(function(){g=!1,a("#snap-move-message-title .spinner-three-quarters").remove()})},o=function(b,c,e){b.preventDefault();var f=M.cfg.wwwroot+"/course/rest.php",g=a(a(c).parents(".snap-asset")[0]),h=g.attr("id").replace("module-","");m(a(g).find(".snap-meta"),!0);var i=M.theme_snap.courseid;a.ajax({type:"POST",async:!0,url:f,dataType:"html",complete:function(){g.find(".snap-meta .loadingstat").remove()},error:function(){var a=M.util.get_string("error:failedtochangeassetvisibility","theme_snap");d.alert(null,a,M.util.get_string("ok"))},success:function(){e?g.removeClass("draft"):g.addClass("draft")},data:{id:h,"class":"resource",field:"visible",sesskey:M.cfg.sesskey,value:e?1:0,courseId:i}})},p=function(c){var d={};b.debug("Move objects",f),d["class"]="resource",k(),e=f.shift(),d.id=Number(e.id.replace("module-","")),c&&!a(c).hasClass("snap-drop")?d.beforeId=Number(a(c)[0].id.replace("module-","")):d.beforeId=0,"page-site-index"===document.body.id?d.sectionId=1:c?d.sectionId=Number(a(c).parents("li.section.main")[0].id.replace("section-","")):d.sectionId=Number(a(e).parents("li.section.main")[0].id.replace("section-","")),f.length>0?n(d,c,function(){a(c).before(a(e)),p(c)},!1):n(d,c,function(){a(c).before(a(e))},!0)},q=function(b){var c=a(b).data("id"),d=a("#section-"+c),e=a(f[0]).attr("id").replace("section-","");c>e&&(c-=1);var g={"class":"section",id:e,value:c};n(g,d,function(){var a=g.value;location.href=location.href.replace(location.hash,"")+"#section-"+a,location.reload(!0)},!0)},r=function(){a(document).on("click",".snap-asset-actions .js_snap_hide",function(a){o(a,this,!1)}),a(document).on("click",".snap-asset-actions .js_snap_show",function(a){o(a,this,!0)}),a(document).on("click",".snap-asset-actions .js_snap_duplicate",function(b){b.preventDefault();var c=a(a(this).parents(".snap-asset")[0]),e=c.attr("id").replace("module-","");m(a(c).find(".snap-meta"),!0);var f=M.theme_snap.courseid,g=M.cfg.wwwroot+"/course/rest.php";a.ajax({type:"POST",async:!0,url:g,dataType:"json",complete:function(){c.find(".snap-meta .loadingstat").remove()},error:function(){var a=M.util.get_string("error:failedtoduplicateasset","theme_snap");d.alert(null,a,M.util.get_string("ok"))},success:function(b){a(b.fullcontent).insertAfter(c)},data:{"class":"resource",field:"duplicate",id:e,sr:0,sesskey:M.cfg.sesskey,courseId:f}})})},s=function(){a("#region-main").on("click",".snap-section-editing.actions .snap-move",function(c){c.stopPropagation(),c.preventDefault(),a("body").addClass("snap-move-inprogress");var d=a(this).data("id");b.debug("Section is",d);var e=a("#section-"+d),g=e.find(".sectionname").text();b.debug("Moving this section",g),f=[e],a(".section-moving").removeClass("section-moving"),e.addClass("section-moving"),a("a[href$=#section-"+d+"]").parent("li").addClass("section-moving"),a("body").addClass("snap-move-section");var i=M.util.get_string("moving","theme_snap",g);h.find(".snap-move-message-title").html(i),h.focus(),a(".section-drop").each(function(){var b=M.util.get_string("movingdropsectionhelp","theme_snap",{moving:g,before:a(this).data("title")});a(this).html(b)}),a("#snap-move-message p.sr-only").html(M.util.get_string("movingstartedhelp","theme_snap",g))})},t=function(){"page-site-index"===document.body.id?a("#region-main .sitetopic ul.section").append('<li class="snap-drop asset-drop"><div class="asset-wrapper"><a href="#">'+M.util.get_string("movehere","theme_snap")+"</a></div></li>"):a("li.section .content ul.section").append('<li class="snap-drop asset-drop"><div class="asset-wrapper"><a href="#">'+M.util.get_string("movehere","theme_snap")+"</a></div></li>")},u=function(){a("#region-main").on("change",".js-snap-asset-move",function(c){c.stopPropagation();var d=a(this).parents(".snap-asset")[0],e=a(d).parents("ul.section")[0],g=a(e).find("li.snap-drop.asset-drop");if(a(e).append(g),0===f.length){var h=a(d).find(".snap-asset-link .instancename").html();b.debug("Moving this asset",h);var j=a(d).attr("class"),m=/(?=snap-mime)([a-z0-9\-]*)/,n=m.exec(j);j="",n&&(j=n.join(" ")),b.debug("Moving this class",j),a(d).addClass("asset-moving"),a(d).find(".js-snap-asset-move").prop("checked","checked"),a("body").addClass("snap-move-inprogress"),a("body").addClass("snap-move-asset")}a(this).prop("checked")?(f.push(d),a(d).addClass("asset-moving")):(l(d),a(d).removeClass("asset-moving"),0===f.length&&i()),k()})},v=function(){a(document).on("click",".snap-move-note, .snap-drop",function(c){if(b.debug("Snap drop clicked",c),f)if(c.stopPropagation(),c.preventDefault(),a("body").hasClass("snap-move-section"))q(this);else{var d;d=a(this).hasClass("snap-drop")?this:a(this).closest(".snap-asset"),p(d)}})},w=function(){a(".snap-move-cancel").click(function(a){a.preventDefault(),i()})},x=function(){M.course&&M.course.resource_toolbox&&(M.course.resource_toolbox.handle_resource_dim=function(a,b,c){return"hide"===c?0:1})},y=function(){s(),u(),w(),v(),r(),t(),a("body").addClass("snap-course-listening")},z=function(){a("#snap-move-message").length||c.render("theme_snap/snap_move_notice",{}).done(function(b){a("#region-main").append(b),h=a("#snap-move-message")}),y(),x()};z()}}});